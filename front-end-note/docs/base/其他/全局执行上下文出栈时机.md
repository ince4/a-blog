# 全局执行上下文出栈时机

> 本节标题的提问来自 segmentfault [JS运行过程中，全局执行上下文一直在执行上下文栈中吗。](https://segmentfault.com/q/1010000015608763)  

## 1、结论
从该问题提出者自己的回答中得出了以下结论
- 全局上下文会出栈，并不是一直在栈底。
- 执行全局代码（如通过浏览器控制台）的时候会再次创建全局上下文。
- 事件循环中执行队列中的事件时会再次创建上下文。

我认为结论中第二点与第三点可以进行合并，因为全局同步代码也可以看作是宏任务（Task）

> 前置知识点：[事件循环](/base/浏览器/事件循环)  

![Image text](/浏览器/16740fa4cd9c6937.webp)

在事件循环期间的某个时刻，主线程会开始运行最先进入宏任务队列的消息。被处理的消息会被移出队列，并作为输入参数来调用与之关联的函数。调用一个函数总是会为其创造一个新的执行上下文。  
函数的处理会一直进行到执行栈再次为空为止；然后事件循环将会处理队列中的下一个消息。

## 2、验证



### 例1
```javascript
button.addEventListener('click' () => {
	Promise.resolve().then(() => console.log('Microtask 1'))
	console.log('Listener 1')
})

button.addEventListener('click' () => {
	Promise.resolve().then(() => console.log('Microtask 2'))
	console.log('Listener 2')
})
```

### 例2
```javascript
button.addEventListener('click' () => {
	Promise.resolve().then(() => console.log('Microtask 1'))
	console.log('Listener 1')
})

button.addEventListener('click' () => {
	Promise.resolve().then(() => console.log('Microtask 2'))
	console.log('Listener 2')
})

button.click()
```

### 执行结果
```javascript
// 例1中，通过鼠标点击 button 触发 DOM 事件，输出顺序为
'Listener 1'
'Microtask 1'
'Listener 2'
'Microtask 2'

// 例2中，通过 click() 方法模拟触发 DOM 事件 输出顺序为
'Listener 1'
'Listener 2'
'Microtask 1'
'Microtask 2'
```




<!-- 参考：https://www.youtube.com/watch?v=cCOL7MC4Pl0&t=1592s -->