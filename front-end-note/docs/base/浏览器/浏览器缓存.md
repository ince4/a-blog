# 浏览器缓存

## 1、强缓存
在强缓存有效期内，客户端直接读取本地资源，可以直接从缓存中获取数据无需再次请求。  
- 返回的状态码是200

### Expires
在 http1.0 中使用，表示缓存资源失效的具体时间点

```javascript
Expires:Sat, 09 Jun 2018 08:13:56 GMT 
```

若服务器时间和本地时间不一致，缓存有效时间会不准确。在 http1.1 及之后的版本中多使用 Cache-control 字段的 max-age 属性来控制强缓存有效时间。
### Cache-control
指定指令来实现缓存机制，多个指令间逗号分隔，常见的指令如下  

- max-age：强缓存的有效时间，单位为秒
- s-maxage：代理服务器的缓存有效时间
- no-cache：不使用强缓存，进入协商缓存阶段
- no-store：禁止浏览器缓存数据，每次用户请求该资源，都会向服务器发送请求下载资源
- private ：表明响应只能被浏览器缓存，不能被代理服务器不能缓存

## 2、协商缓存
协商缓存在使用本地缓存之前需要先跟服务器做个对比，若本地资源是最新的可以直接读取，反之，服务器返回最新的资源给客户端，客户端收到后更新本地资源。

- 若本地资源是最新的，状态码为 304
- 若比对后，需要从服务器获取最新资源，状态码为 200

### Last-Modified 与 If-Modified-Since
采用资源最后修改时间来判断，单位精度秒

- Last-Modified：浏览器第一次给服务器发送请求后，服务器会在响应头中加上Last-Modified字段（在之后的请求中作为 If-Modified-Since 的值）。
- If-Modified-Since：发起协商，把本地记录的文件更新时间传给服务器（请求头中携带If-Modified-Since字段），服务器将其与服务器上**资源最后修改时间**进行判断比较

该判断方式是 http1.0 的产物，因为时间精度是秒，若文件的更新频率在秒级以内，就会出现文件不一致。

### ETag 与 If-None-Match
ETag 是服务器根据当前文件的内容，给文件生成的唯一标识，只要里面的内容有改动，这个值就会变。服务器通过响应头把这个值给浏览器。

- ETag：服务器根据内容生成唯一的字符串标识
- If-None-Match：客户端发起协商，把本地记录的 hash 标识传给服务器，服务器进行判断比较。

若协商缓存同时支持 Last-Modified 和 ETag 的方式，优先根据 Etag 判断。

## 3、流程总结
![Image text](/浏览器/缓存.png)
- 如果强缓存可用，直接使用
- 若强缓存不可用，进入协商缓存。发送 HTTP 请求，服务器根据请求头中的数据检查资源是否更新
    - 若资源更新，返回资源和200状态码
    - 否则，返回304，告诉浏览器直接从缓存获取资源