# 浏览器渲染
页面是采用流式布局来绘制，左到右，上到下。

![DOM渲染](/浏览器/DOM渲染.webp)

## 1、URL输入到页面展示 

1. 构建请求
2. 查找强缓存
3. 域名解析，找到服务地址
4. 建立 TCP 连接
5. 发送 HTTP 请求
6. 解析文档并构建 DOM 树： 将字节数据转为字符串，再通过解释器构建节点形成 DOM 树和 CSSOM 树
7. 生成渲染树：从 DOM 树的根节点开始遍历每个可见节点，并根据 CSSOM 树中对应的规则组合生成渲染树
8. Layout：根据生成的渲染树，进行回流，得到节点的集合信息
9. Painting：根据渲染树及其回流得到的集合信息，得到节点的绝对像素。
10. 输出像素绘制在页面上展示

## 2、回流与重绘
**回流**指元素的空间属性发生变化，重新进行收集节点信息对受影响的元素进行绘制。  
**重绘**指的是对元素的外观做处理，比如颜色、背景、阴影等。  
因此回流一定触发重绘。

以下几个动作会触发回流：

- 添加或删除可见的DOM元素
- 元素的位置发生变化
- 元素的尺寸发生变化（包括外边距、内边框、边框大小、高度和宽度等）
- 内容发生变化，比如文本变化或图片被另一个不同尺寸的图片所替代。
- 页面最初开始渲染的时候
- 浏览器的窗口尺寸变化（回流是根据视口的大小来计算元素的位置和大小的）
- 获取位置信息，需要回流计算最新的值

> 页面更新时机由浏览器控制，当 Eventloop 执行完 Microtasks 后浏览器会判断是否需要更新。  
> 更新时会先触发 requestAnimationFrame，之后计算样式并更新页面

## 3、GPU加速
开启后 GPU 加速后，会将对应需要进行动画的元素 DOM 元素提升为独立的渲染层，它的变化不会再影响文档流中的布局（避免回流重绘）。  
浏览器在一帧里面，会依次执行以下这些动作  

![Image text](/浏览器/页面更新.png)  

- JavaScript：JavaScript 实现动画效果，DOM 元素操作等。
- Style（计算样式）：确定每个 DOM 元素应该应用什么 CSS 规则。
- Layout（布局）：计算每个 DOM 元素在最终屏幕上显示的大小和位置。由于 web 页面的元素布局是相对的，所以其中任意一个元素的位置发生变化，都会联动的引起其他元素发生变化，这个过程叫 - reflow。
- Paint（绘制）：在多个层上绘制 DOM 元素的的文字、颜色、图像、边框和阴影等。
- Composite（渲染层合并）：按照合理的顺序合并图层然后显示到屏幕上。

> 利用 GPU 加速优先使用渲染层合并属性，减少 layout，paint 的触发。如通过改变元素的 transform 实现移动、伸缩变换而非改变物体的 left，top，width，height属性。如果动画并不需要对 transform 和 opacity 属性做出改变，也可以使用其他的方法强制浏览器为这些元素创建单独的层。

以下属性会触发 GPU 加速
- transform: translateZ()
- opacity
- filters
- Will-change